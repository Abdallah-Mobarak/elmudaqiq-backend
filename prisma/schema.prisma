generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Role {
  id    Int    @id @default(autoincrement())
  name  String
  users User[]
}

model User {
  id           Int       @id @default(autoincrement())
  fullName     String
  email        String    @unique
  password     String
  phone        String?
  status       String    @default("active")
  roleId       Int
  Role         Role      @relation(fields: [roleId], references: [id])
  otp          String?
  otpExpiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  activityLogs ActivityLog[]
}

model Country {
  id              Int     @id @default(autoincrement())
  name            String  @unique
  cpaWebsite      String?
  commerceWebsite String?
  taxWebsite      String?

  cities      City[]
  subscribers Subscriber[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model City {
  id        Int      @id @default(autoincrement())
  name      String
  country   Country  @relation(fields: [countryId], references: [id])
  countryId Int
  regions   Region[]

  subscribers Subscriber[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model Region {
  id     Int    @id @default(autoincrement())
  name   String
  city   City   @relation(fields: [cityId], references: [id])
  cityId Int

  subscribers Subscriber[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model SystemSettings {
  id                 Int      @id @default(autoincrement())
  companyName        String?
  companyEmail       String?
  companyPhone       String?
  address            String?
  taxNumber          String?
  commercialRegister String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model AuthorityWebsite {
  id        Int      @id @default(autoincrement())
  name      String
  url       String
  category  String?
  notes     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AccountGuide {
  id Int @id @default(autoincrement())

  level         String
  accountNumber Int
  accountName   String

  rulesAndRegulations String?
  disclosureNotes     String?

  code1 String?
  code2 String?
  code3 String?
  code4 String?
  code5 String?
  code6 String?
  code7 String?
  code8 String?

  objectiveCode     String?
  relatedObjectives String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ReviewGuide {
  id                Int       @id @default(autoincrement())
  level             String?
  separator         String?
  number            String?
  statement         String?
  purpose           String?
  responsiblePerson String?
  datePrepared      DateTime?
  dateReviewed      DateTime?
  conclusion        String?
  attachments       String?
  notes1            String?
  notes2            String?
  notes3            String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

model FileStage {
  id                    Int     @id @default(autoincrement())
  stageCode             String?
  stage                 String?
  entityType            String?
  economicSector        String?
  procedure             String?
  scopeOfProcedure      String?
  selectionMethod       String?
  examplesOfUse         String?
  IAS                   String?
  IFRS                  String?
  ISA                   String?
  relevantPolicies      String?
  detailedExplanation   String?
  formsToBeCompleted    String?
  practicalProcedures   String?
  associatedRisks       String?
  riskLevel             String?
  responsibleAuthority  String?
  outputs               String?
  implementationPeriod  String?
  strengths             String?
  potentialWeaknesses   String?
  performanceIndicators String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ReviewObjective {
  id                   Int     @id @default(autoincrement())
  objectiveCode        String?
  objectiveDescription String?
  objectiveCategory    String?
  relatedProcedures    String?
  expectedOutput       String?
  risks                String?
  riskLevel            String?
  controlMeasures      String?
  indicators           String?
  referenceStandards   String?
  notes                String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ReviewObjectiveStage {
  id                          Int     @id @default(autoincrement())
  codesCollected              String? // "A,B,C"
  numberOfCollectedObjectives Int? // auto calculated

  ethicalCompliancePercentage    Float?
  professionalPlanningPercentage Float?
  internalControlPercentage      Float?
  evidencePercentage             Float?
  evaluationPercentage           Float?
  documentationPercentage        Float?

  totalRelativeWeight  Float?
  implementationStatus String?
  actualPerformance    Float?
  gapPercentage        Float?

  codeOfEthics String?
  policies     String?
  ifrs         String?
  ias          String?
  notes        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ReviewMarkIndex {
  id Int @id @default(autoincrement())

  codeImage        String? // image path
  name             String?
  shortDescription String?
  suggestedStage   String?
  whenToUse        String?
  exampleShortForm String?
  sectorTags       String?
  assertion        String?
  benchmark        String?

  scoreWeight    Float?
  severityLevel  Int?
  severityWeight Float?

  priorityScore  Float? // auto calculated
  priorityRating String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum SubscriberStatus {
  ACTIVE
  INACTIVE
  PENDING
  SUSPENDED
}

model Subscriber {
  id Int @id @default(autoincrement())

  // ===============================
  // Location
  // ===============================
  countryId Int
  cityId    Int
  regionId  Int

  country Country @relation(fields: [countryId], references: [id])
  city    City    @relation(fields: [cityId], references: [id])
  region  Region  @relation(fields: [regionId], references: [id])

  cpaWebsite      String?
  commerceWebsite String?
  taxWebsite      String?

  // ===============================
  // License
  // ===============================
  licenseType        String
  licenseNumber      String   @unique
  licenseCertificate String
  licenseDate        DateTime
  licenseName        String

  // ===============================
  // Legal Entity
  // ===============================
  legalEntityType        String
  legalEntityNationality String

  articlesOfAssociationFile String?
  commercialRegisterFile    String?
  ownersNames               String
  commercialRegisterNumber  String

  taxNumber          String
  taxCertificateFile String

  unifiedNumber     String
  unifiedNumberFile String

  commercialActivityFile String
  commercialRegisterDate DateTime
  fiscalYear             DateTime

  subscriberEmail String
  primaryMobile   String

  // ===============================
  // Security & Admin
  // ===============================
  status           SubscriberStatus @default(PENDING)
  subscriptionDate DateTime?
  lastLogin        DateTime?
  internalNotes    String?

  // ===============================
  // Subscription & Billing
  // ===============================
  subscriptionType      String?
  subscriptionStartDate DateTime?
  subscriptionEndDate   DateTime?
  paidFees              Float?
  paymentMethod         String?
  numberOfUsers         Int?
  numberOfClients       Int?
  numberOfBranches      Int?

  // ===============================
  // Renewal Report Fields (1.5)
  // ===============================
  lastRenewalNotification DateTime?
  renewalStatus           String    @default("PENDING")

  // ===============================
  // Technical
  // ===============================
  facilityLink String?
  factoryLogo  String?
  language     String?
  currency     String?

  // ===============================
  // System
  // ===============================
  subdomain String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ===============================
  // Relation
  // =============================== 
  complaints    Complaint[]
  notifications Notification[]
  activityLogs  ActivityLog[]
}

enum ComplaintType {
  COMMERCIAL
  TECHNICAL
}

model Complaint {
  id Int @id @default(autoincrement())

  // ===============================
  // Subscriber Relation
  // ===============================
  subscriberId Int
  subscriber   Subscriber @relation(fields: [subscriberId], references: [id])

  // ===============================
  // Complaint Data
  // ===============================
  subscriberName String
  phone          String
  email          String
  message        String

  type          ComplaintType
  complaintDate DateTime      @default(now())

  // ===============================
  // Admin Response
  // ===============================
  response    String?
  respondedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Notification {
  id Int @id @default(autoincrement())

  title   String
  message String

  // Subscriber Notification  
  subscriberId Int?
  subscriber   Subscriber? @relation(fields: [subscriberId], references: [id])

  // Admin Notification 
  isRead Boolean @default(false)

  type String // RENEWAL | COMPLAINT | SYSTEM

  createdAt DateTime @default(now())
}

model ActivityLog {
  id Int @id @default(autoincrement())

  userId Int?
  user   User? @relation(fields: [userId], references: [id])

  subscriberId Int?
  subscriber   Subscriber? @relation(fields: [subscriberId], references: [id])

  userType String // ADMIN | SUBSCRIBER
  action   String
  message  String

  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())
}
