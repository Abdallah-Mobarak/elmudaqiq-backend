generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Role {
  id    Int    @id @default(autoincrement())
  name  String @unique
  users User[]
}

model User {
  id       Int     @id @default(autoincrement())
  fullName String
  email    String
  password String
  phone    String?
  status   String  @default("active")
  mustChangePassword Boolean @default(false)

  roleId Int
  Role   Role @relation(fields: [roleId], references: [id])

  subscriberId Int?
  subscriber   Subscriber? @relation(fields: [subscriberId], references: [id])

  otp          String?
  otpExpiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  activityLogs ActivityLog[]

  @@unique([email, subscriberId])
}

model Country {
  id              Int     @id @default(autoincrement())
  name            String  @unique
  cpaWebsite      String?
  commerceWebsite String?
  taxWebsite      String?

  cities      City[]
  subscribers Subscriber[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model City {
  id        Int      @id @default(autoincrement())
  name      String
  country   Country  @relation(fields: [countryId], references: [id])
  countryId Int
  regions   Region[]

  subscribers Subscriber[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model Region {
  id     Int    @id @default(autoincrement())
  name   String
  city   City   @relation(fields: [cityId], references: [id])
  cityId Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SystemSettings {
  id                 Int      @id @default(autoincrement())
  companyName        String?
  companyEmail       String?
  companyPhone       String?
  address            String?
  taxNumber          String?
  commercialRegister String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model AuthorityWebsite {
  id        Int      @id @default(autoincrement())
  name      String
  url       String
  category  String?
  notes     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ===============================
// 1. Account Guide (Templates & Tenant)
// ===============================
model AccountGuideTemplate {
  id Int @id @default(autoincrement())
  level         String @db.Text
  accountNumber Int
  accountName   String @db.Text
  rulesAndRegulations String? @db.Text
  disclosureNotes     String? @db.Text
  code1 String? @db.Text
  code2 String? @db.Text
  code3 String? @db.Text
  code4 String? @db.Text
  code5 String? @db.Text
  code6 String? @db.Text
  code7 String? @db.Text
  code8 String? @db.Text
  objectiveCode     String? @db.Text
  relatedObjectives String? @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AccountGuide {
  id Int @id @default(autoincrement())

  subscriberId Int
  subscriber   Subscriber @relation(fields: [subscriberId], references: [id])

  level         String
  accountNumber Int
  accountName   String @db.Text

  rulesAndRegulations String? @db.Text
  disclosureNotes     String? @db.Text

  code1 String? @db.Text
  code2 String? @db.Text
  code3 String? @db.Text
  code4 String? @db.Text
  code5 String? @db.Text
  code6 String? @db.Text
  code7 String? @db.Text
  code8 String? @db.Text

  objectiveCode     String? @db.Text
  relatedObjectives String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([subscriberId])
  @@index([accountNumber])
  @@index([level])
}

// ===============================
// 2. Review Guide (Templates & Tenant)
// ===============================
model ReviewGuideTemplate {
  id                Int       @id @default(autoincrement())
  level             String?
  separator         String?
  number            String?
  statement         String?
  purpose           String?
  responsiblePerson String?
  datePrepared      DateTime?
  dateReviewed      DateTime?
  conclusion        String?
  attachments       String?
  notes1            String?
  notes2            String?
  notes3            String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

model ReviewGuide {
  id                Int       @id @default(autoincrement())
  subscriberId      Int
  subscriber        Subscriber @relation(fields: [subscriberId], references: [id])

  level             String?
  separator         String?
  number            String?
  statement         String?
  purpose           String?
  responsiblePerson String?
  datePrepared      DateTime?
  dateReviewed      DateTime?
  conclusion        String?
  attachments       String?
  notes1            String?
  notes2            String?
  notes3            String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([subscriberId])
}

// ===============================
// 3. File Stage (Templates & Tenant)
// ===============================
model FileStageTemplate {
  id                    Int     @id @default(autoincrement())
  stageCode             String?
  stage                 String?
  entityType            String?
  economicSector        String?
  procedure             String?
  scopeOfProcedure      String?
  selectionMethod       String?
  examplesOfUse         String?
  IAS                   String?
  IFRS                  String?
  ISA                   String?
  relevantPolicies      String?
  detailedExplanation   String?
  formsToBeCompleted    String?
  practicalProcedures   String?
  associatedRisks       String?
  riskLevel             String?
  responsibleAuthority  String?
  outputs               String?
  implementationPeriod  String?
  strengths             String?
  potentialWeaknesses   String?
  performanceIndicators String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model FileStage {
  id                    Int     @id @default(autoincrement())
  subscriberId          Int
  subscriber            Subscriber @relation(fields: [subscriberId], references: [id])

  stageCode             String?
  stage                 String?
  entityType            String?
  economicSector        String?
  procedure             String?
  scopeOfProcedure      String?
  selectionMethod       String?
  examplesOfUse         String?
  IAS                   String?
  IFRS                  String?
  ISA                   String?
  relevantPolicies      String?
  detailedExplanation   String?
  formsToBeCompleted    String?
  practicalProcedures   String?
  associatedRisks       String?
  riskLevel             String?
  responsibleAuthority  String?
  outputs               String?
  implementationPeriod  String?
  strengths             String?
  potentialWeaknesses   String?
  performanceIndicators String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([subscriberId])
}

// ===============================
// 4. Review Objective (Templates & Tenant)
// ===============================
model ReviewObjectiveStageTemplate {
  id                          Int     @id @default(autoincrement())
  codesCollected              String? 
  numberOfCollectedObjectives Int? 
  ethicalCompliancePercentage    Float?
  professionalPlanningPercentage Float?
  internalControlPercentage      Float?
  evidencePercentage             Float?
  evaluationPercentage           Float?
  documentationPercentage        Float?
  totalRelativeWeight  Float?
  codeOfEthics String?
  policies     String?
  ifrs         String?
  ias          String?
  notes        String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ReviewObjectiveStage {
  id                          Int     @id @default(autoincrement())
  subscriberId                Int
  subscriber                  Subscriber @relation(fields: [subscriberId], references: [id])

  codesCollected              String? // "A,B,C"
  numberOfCollectedObjectives Int? // auto calculated

  ethicalCompliancePercentage    Float?
  professionalPlanningPercentage Float?
  internalControlPercentage      Float?
  evidencePercentage             Float?
  evaluationPercentage           Float?
  documentationPercentage        Float?

  totalRelativeWeight  Float?
  implementationStatus String?
  actualPerformance    Float?
  gapPercentage        Float?

  codeOfEthics String?
  policies     String?
  ifrs         String?
  ias          String?
  notes        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([subscriberId])
}

// ===============================
// 5. Review Mark Index (Templates & Tenant)
// ===============================
model ReviewMarkIndexTemplate {
  id Int @id @default(autoincrement())
  codeImage        String? 
  name             String?
  shortDescription String?
  suggestedStage   String?
  whenToUse        String?
  exampleShortForm String?
  sectorTags       String?
  assertion        String?
  benchmark        String?
  scoreWeight    Float?
  severityLevel  Int?
  severityWeight Float?
  priorityScore  Float? 
  priorityRating String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ReviewMarkIndex {
  id Int @id @default(autoincrement())
  subscriberId Int
  subscriber   Subscriber @relation(fields: [subscriberId], references: [id])

  codeImage        String? // image path
  name             String?
  shortDescription String?
  suggestedStage   String?
  whenToUse        String?
  exampleShortForm String?
  sectorTags       String?
  assertion        String?
  benchmark        String?

  scoreWeight    Float?
  severityLevel  Int?
  severityWeight Float?

  priorityScore  Float? // auto calculated
  priorityRating String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([subscriberId])
}

model Subscription {
  id Int @id @default(autoincrement())

  subscriberId Int
  subscriber   Subscriber @relation(fields: [subscriberId], references: [id])

  planId Int
  plan   Plan @relation(fields: [planId], references: [id])

  startDate DateTime
  endDate   DateTime

  amountPaid    Float
  paymentMethod String?
  paymentStatus String             @default("PAID")
  status        SubscriptionStatus @default(ACTIVE)

  gracePeriodEnd DateTime?
  autoRenew      Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  payments Payment[]
}

enum SubscriberStatus {
  ACTIVE
  INACTIVE
  PENDING
  SUSPENDED
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
  PENDING
}

model Subscriber {
  id Int @id @default(autoincrement())

  // ===============================
  // Location
  // ===============================
  countryId Int
  cityId    Int
  // regionId  Int

  country         Country @relation(fields: [countryId], references: [id])
  city            City    @relation(fields: [cityId], references: [id])
  // region  Region  @relation(fields: [regionId], references: [id])
  cpaWebsite      String?
  commerceWebsite String?
  taxWebsite      String?

  // ===============================
  // License
  // ===============================
  licenseType        String
  licenseNumber      String   @unique
  licenseCertificate String
  licenseDate        DateTime
  licenseName        String

  // ===============================
  // Legal Entity
  // ===============================
  legalEntityType        String
  legalEntityNationality String

  articlesOfAssociationFile String?
  commercialRegisterFile    String?
  ownersNames               String
  commercialRegisterNumber  String

  taxNumber          String
  taxCertificateFile String

  unifiedNumber String
  // unifiedNumberFile String

  commercialActivityFile String
  commercialRegisterDate DateTime
  commercialExpireDate   DateTime?

  fiscalYear DateTime

  subscriberEmail String
  primaryMobile   String

  // ===============================
  // Security & Admin
  // ===============================
  status           SubscriberStatus @default(PENDING)
  subscriptionDate DateTime?
  lastLogin        DateTime?
  internalNotes    String?

  // ===============================
  // Subscription & Billing
  // ===============================
  // Fields moved to Subscription model

  // ===============================
  // Renewal Report Fields (1.5)
  // ===============================
  lastRenewalNotification DateTime?
  renewalStatus           String    @default("PENDING")

  // ===============================
  // Technical
  // ===============================
  facilityLink String?
  factoryLogo  String?
  language     String?
  currency     String?

  // ===============================
  // System
  // ===============================
  subdomain String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ===============================
  // Relation
  // =============================== 
  complaints    Complaint[]
  notifications Notification[]
  activityLogs  ActivityLog[]
  payments      Payment[]
  users         User[]
  subscriptions Subscription[]
  accountGuides AccountGuide[]
  reviewGuides  ReviewGuide[]
  fileStages    FileStage[]
  reviewObjectiveStages ReviewObjectiveStage[]
  reviewMarkIndices     ReviewMarkIndex[]
}

enum ComplaintType {
  COMMERCIAL
  TECHNICAL
}

model Complaint {
  id Int @id @default(autoincrement())

  // ===============================
  // Subscriber Relation
  // ===============================
  subscriberId Int
  subscriber   Subscriber @relation(fields: [subscriberId], references: [id])

  // ===============================
  // Complaint Data
  // ===============================
  subscriberName String
  phone          String
  email          String
  message        String

  type          ComplaintType
  complaintDate DateTime      @default(now())

  // ===============================
  // Admin Response
  // ===============================
  response    String?
  respondedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Notification {
  id Int @id @default(autoincrement())

  title   String
  message String

  // Subscriber Notification  
  subscriberId Int?
  subscriber   Subscriber? @relation(fields: [subscriberId], references: [id])

  // Admin Notification 
  isRead Boolean @default(false)

  type String // RENEWAL | COMPLAINT | SYSTEM

  createdAt DateTime @default(now())
}

model ActivityLog {
  id Int @id @default(autoincrement())

  userId Int?
  user   User? @relation(fields: [userId], references: [id])

  subscriberId Int?
  subscriber   Subscriber? @relation(fields: [subscriberId], references: [id])

  userType String // ADMIN | SUBSCRIBER
  action   String
  message  String

  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())
}

model UploadedFile {
  id        Int      @id @default(autoincrement())
  name      String
  path      String
  size      Int
  type      String // EXCEL | IMAGE | PDF
  source    String // SUBSCRIBER | COMPLAINT | REVIEW | ACCOUNT
  createdAt DateTime @default(now())
}

model Payment {
  id Int @id @default(autoincrement())

  subscriberId Int
  subscriber   Subscriber @relation(fields: [subscriberId], references: [id])

  subscriptionId Int?
  subscription   Subscription? @relation(fields: [subscriptionId], references: [id])

  amount Float
  method String // CASH | VISA | WALLET
  status String // PAID | REFUNDED | PENDING

  paidAt DateTime @default(now())

  createdAt DateTime @default(now())
}

model Plan {
  id             Int     @id @default(autoincrement())
  name           String
  description    String?
  durationMonths Int
  paidFees       Float
  usersLimit     Int
  fileLimit      Int
  maxFileSizeMB  Int?
  branchesLimit  Int
  isActive       Boolean @default(true)

  // subscribers Subscriber[] // Removed direct relation
  subscriptions Subscription[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
